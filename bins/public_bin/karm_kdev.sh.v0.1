#!/bin/bash
#script to add/start tasks in KArm corresponding to current KDev project :)

#initialize variables
TIMESTEP=1
PREVIOUS_PROJECT=NULL
CURRENT_PROJECT=NULL
KARM_DCOPID=

#make sure karm is running before continuing
while [ ! $KARM_DCOPID ]
do
    echo "KArm not running"
    KARM_DCOPID=`dcop | grep karm`
done
echo "Karm running"

#make sure karm is hidden and all tasks stopped
KARM_DCOPID=`dcop | grep karm`
if [ $KARM_DCOPID ]
then
    #hide karm window
    dcop $KARM_DCOPID karm-mainwindow#1 hide
    #export CSV file to ~/karm.log
    dcop $KARM_DCOPID KarmDCOPIface exportcsvfile ~/karm.log "" "" 0 true true " " ""
    #display all tasks :)
    awk '{ FS=" " }{ print $1 }' ~/karm.log | sort -u
    #stop all tasks just in case
    awk '{ FS=" " }{ print $1 }' ~/karm.log | sort -u | xargs -n1 dcop $KARM_DCOPID KarmDCOPIface stoptimerfor
else
    echo "KArm not running"
fi

#start infinite loop to obtain daemon-like behaviour
while true
do
    #check that karm is running
    KARM_DCOPID=`dcop | grep karm`
    if [ $KARM_DCOPID ]
    then
        #check that kdevelop is running
        KDEV_DCOPID=`dcop | grep kdevelop`
        if [ $KDEV_DCOPID ]
        then
            #check that a kdev project is open
            dcop $KDEV_DCOPID KDevProject 1>/dev/null 2>&1
            if [ $? = 0 ]
            then
                CURRENT_PROJECT=`dcop $KDEV_DCOPID KDevProject projectName`
                echo $CURRENT_PROJECT
                #check that a task with a name of the kdev project exists
                ID=`dcop $KARM_DCOPID KarmDCOPIface taskIdFromName $CURRENT_PROJECT`
                if [ $ID ]
                then
                    echo "task does exist"
                else
                    echo "task does not exist"
                    echo "adding task $CURRENT_PROJECT"
                    dcop $KARM_DCOPID KarmDCOPIface addTask $CURRENT_PROJECT
                fi
                #check if the current open project has changed
                if [ $CURRENT_PROJECT != $PREVIOUS_PROJECT ]
                then
                    echo "project changed"
                    echo "stopping $PREVIOUS_PROJECT"
                    dcop $KARM_DCOPID KarmDCOPIface stoptimerfor $PREVIOUS_PROJECT
                    echo "starting $CURRENT_PROJECT"
                    dcop $KARM_DCOPID KarmDCOPIface starttimerfor $CURRENT_PROJECT
                else
                    echo "project still the same"
                fi
                PREVIOUS_PROJECT=$CURRENT_PROJECT
            else
                echo "no KDevProject open"
                dcop $KARM_DCOPID KarmDCOPIface stoptimerfor $PREVIOUS_PROJECT
                PREVIOUS_PROJECT=NULL
                CURRENT_PROJECT=NULL
            fi
        else
            echo "KDevelop not running"
            dcop $KARM_DCOPID KarmDCOPIface stoptimerfor $PREVIOUS_PROJECT
            PREVIOUS_PROJECT=NULL
            CURRENT_PROJECT=NULL
        fi
    else
        echo "KArm not running"
    fi
    sleep $TIMESTEP
done
